<!DOCTYPE html>
<html lang="en">

<head>
  <title>Preview</title>

  <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>

  <style>
    * {
      color: black;
    }

    html {
      background: #fafafa;
    }

    @media (prefers-color-scheme: dark) {
      * {
        color: white;
      }

      input,
      button {
        background-color: #333 !important;
        color: white !important;
      }
    }
  </style>

  <link rel="stylesheet" href="reset.css">

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- <meta http-equiv="refresh" content="2"> -->
</head>

<body>
  <div id="templateContainer"></div>

  <script>
    let templates = {}
    let hooks
    let helpers
    let partials

    const messageParent = (message) => {
      const parent = window.top
      parent.postMessage(message, '*')
    }

    window.addEventListener('message', (e) => {
      const message = e.data
      console.log('frame heard message', message)

      if (message.type === 'loadTemplate') {
        loadTemplate(message.data)
      }
    })

    // load the given (compiled) handlebars template
    const loadTemplate = (template) => {
      localStorage.setItem('template', template)

      document.getElementById('templateContainer').innerHTML = templates[template](
        // data[template]
      )

      // onchange every input -> 
      // messageParent ->
      // updateValues hook to iframe ->
      // re-render template w. new data -> 
      // e.g. strengthModifier updates
    }

    const evaluateScripts = (scripts) => {
      const fScripts = new Function(scripts) // eslint-disable-line no-new-func
      return (fScripts)()
    }

    fetch('./js/templates.js')
      .then(response => response.text())
      .then(loadedTemplates => {
        templates = evaluateScripts(loadedTemplates)

        fetch('./js/scripts.js')
          .then(response => response.text())
          .then(scripts => {
            const evaluatedScripts = evaluateScripts(scripts)

            hooks = evaluatedScripts.hooks
            helpers = evaluatedScripts.helpers

            // systemHooks.current = hooks || {} // not defined
            if (helpers) Handlebars.registerHelper(helpers)

            fetch('./js/partials.js')
              .then(response => response.text())
              .then(partials => {
                const evaluatedPartials = evaluateScripts(partials)

                if (evaluatedPartials) {
                  Object.keys(evaluatedPartials).forEach(key => {
                    const partialName = key.replace(/\//g, '') // remove slashes introduced by gulp (fix in gulp later)
                    Handlebars.registerPartial(partialName, evaluatedPartials[key])
                  })
                }

                fetch('values.json')
                  .then(response => response.json())
                  .then(values => {
                    // const t = localStorage.getItem('template') || templates[0].type

                    console.log('values', values.character)

                    loadTemplate('character', values['character'])
                  })
              })
          })
      })

  </script>
</body>

</html>